import xmltodict
import base64
import sys

def flatten_node(node):
    """
    최신 Burp XML node(dict/string)를
    구버전 호환 string으로 변환
    """
    if isinstance(node, dict):
        text = node.get('#text', '')
        # base64면 디코딩 후 다시 인코딩 (구버전 호환)
        if node.get('@base64') == 'true':
            try:
                decoded = base64.b64decode(text)
                return base64.b64encode(decoded).decode()
            except Exception:
                return text
        return text
    elif isinstance(node, str):
        return node
    return ''

def main(src, dst):
    with open(src, 'r', encoding='utf-8', errors='ignore') as f:
        data = xmltodict.parse(f.read())

    items = data.get('items', {}).get('item', [])
    if isinstance(items, dict):
        items = [items]

    old_items = []

    for item in items:
        if not isinstance(item, dict):
            continue

        old_item = {}

        for key, value in item.items():
            if key in ('request', 'response'):
                old_item[key] = flatten_node(value)
            else:
                old_item[key] = flatten_node(value)

        old_items.append(old_item)

    old_xml = {
        'items': {
            'item': old_items
        }
    }

    with open(dst, 'w', encoding='utf-8') as f:
        f.write(xmltodict.unparse(old_xml, pretty=True))

    print(f'[+] Converted to old-style Burp XML: {dst}')

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print(f'Usage: python3 {sys.argv[0]} new.xml old.xml')
        sys.exit(1)

    main(sys.argv[1], sys.argv[2])