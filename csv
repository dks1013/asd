import xmltodict
import base64
import sys

def force_string(value):
    """
    어떤 타입이든 무조건 string으로 변환
    """
    if isinstance(value, dict):
        # base64 노드
        if '#text' in value:
            text = value.get('#text', '')
            return text
        return ''
    elif isinstance(value, list):
        return ''
    elif isinstance(value, str):
        return value
    return ''

def main(src, dst):
    with open(src, 'r', encoding='utf-8', errors='ignore') as f:
        data = xmltodict.parse(f.read())

    raw_items = data.get('items', {}).get('item', [])

    # item 1개 대응
    if isinstance(raw_items, dict):
        raw_items = [raw_items]

    old_items = []

    for item in raw_items:
        if not isinstance(item, dict):
            continue

        old_item = {}
        for key, value in item.items():
            old_item[key] = force_string(value)

        old_items.append(old_item)

    old_xml = {
        'items': {
            'item': old_items
        }
    }

    with open(dst, 'w', encoding='utf-8') as f:
        f.write(xmltodict.unparse(old_xml, pretty=True))

    print(f'[+] REALLY old-style XML created: {dst}')

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print(f'Usage: python3 {sys.argv[0]} new.xml old.xml')
        sys.exit(1)

    main(sys.argv[1], sys.argv[2])